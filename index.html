<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Safety Lamp - Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{
            --bg1:#0b1020;
            --bg2:#1b1140;
            --card: rgba(255,255,255,.08);
            --card2: rgba(255,255,255,.12);
            --stroke: rgba(255,255,255,.16);
            --text: rgba(255,255,255,.92);
            --muted: rgba(255,255,255,.68);
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --shadow2: 0 18px 60px rgba(0,0,0,.45);
            --r: 18px;
            --ease: cubic-bezier(.2,.8,.2,1);
        }

        *{ margin:0; padding:0; box-sizing:border-box; }
        html,body{ height:100%; }

        body{
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text);
            background:
              radial-gradient(1200px 700px at 20% 10%, rgba(102,126,234,.35), transparent 55%),
              radial-gradient(900px 600px at 85% 20%, rgba(240,147,251,.25), transparent 55%),
              radial-gradient(900px 700px at 60% 90%, rgba(255,107,107,.18), transparent 60%),
              linear-gradient(135deg, var(--bg1), var(--bg2));
            min-height:100vh;
            padding: 20px;
            overflow-x:hidden;
        }

        /* lightweight ambient animation */
        body::before, body::after{
            content:"";
            position:fixed;
            inset:-20%;
            background:
              radial-gradient(circle at 30% 30%, rgba(102,126,234,.18), transparent 45%),
              radial-gradient(circle at 70% 40%, rgba(240,147,251,.12), transparent 50%),
              radial-gradient(circle at 55% 70%, rgba(16,185,129,.10), transparent 45%);
            filter: blur(30px);
            transform: translate3d(0,0,0);
            z-index:-1;
            animation: drift 18s var(--ease) infinite alternate;
            pointer-events:none;
        }
        body::after{
            opacity:.55;
            animation-duration: 26s;
        }

        @keyframes drift{
            0%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
            100%{ transform: translate3d(2%, 1.5%, 0) scale(1.06); }
        }

        @media (prefers-reduced-motion: reduce){
            *{ animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior:auto !important; }
            body::before, body::after{ display:none; }
        }

        .container{ max-width: 1200px; margin: 0 auto; }

        header{
            background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
            border: 1px solid var(--stroke);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            padding: 18px 22px;
            border-radius: calc(var(--r) + 6px);
            box-shadow: var(--shadow);
            margin-bottom: 18px;
            display:flex;
            justify-content: space-between;
            align-items:center;
            gap: 12px;
        }

        h1{
            font-size: 22px;
            letter-spacing: .2px;
            display:flex;
            align-items:center;
            gap: 12px;
            line-height: 1.1;
        }

        .logo{
            width: 42px;
            height: 42px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(102,126,234,1), rgba(118,75,162,1));
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow: 0 10px 25px rgba(102,126,234,.25);
            transform: translate3d(0,0,0);
            transition: transform .35s var(--ease);
        }
        header:hover .logo{ transform: translate3d(0,-1px,0) rotate(-2deg); }

        .connection-status{
            display:flex;
            gap: 10px;
            align-items:center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .status-badge{
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 650;
            display:flex;
            align-items:center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.06);
            color: var(--text);
            transition: transform .25s var(--ease), background .25s var(--ease);
            will-change: transform;
        }
        .status-badge.connected{
            background: rgba(16,185,129,.18);
            border-color: rgba(16,185,129,.35);
        }
        .status-badge.disconnected{
            background: rgba(239,68,68,.16);
            border-color: rgba(239,68,68,.35);
        }
        .status-badge:hover{ transform: translate3d(0,-1px,0); }

        .status-dot{
            width: 8px; height: 8px; border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 0 0 rgba(255,255,255,.0);
            animation: pulse 1.8s var(--ease) infinite;
            opacity: .9;
        }
        @keyframes pulse{
            0%{ box-shadow: 0 0 0 0 rgba(255,255,255,.0); transform: scale(1); }
            50%{ box-shadow: 0 0 0 8px rgba(255,255,255,.08); transform: scale(1.05); }
            100%{ box-shadow: 0 0 0 0 rgba(255,255,255,.0); transform: scale(1); }
        }

        .dashboard{
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .card{
            background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
            border: 1px solid var(--stroke);
            border-radius: var(--r);
            padding: 18px 18px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            transition: transform .35s var(--ease), box-shadow .35s var(--ease), border-color .35s var(--ease);
            will-change: transform;
            position: relative;
            overflow: hidden;
        }
        .card::before{
            content:"";
            position:absolute;
            inset:-2px;
            background: radial-gradient(500px 200px at 20% 0%, rgba(102,126,234,.18), transparent 55%),
                        radial-gradient(400px 220px at 90% 30%, rgba(240,147,251,.14), transparent 55%);
            opacity: .9;
            pointer-events:none;
        }
        .card > *{ position: relative; z-index: 1; }
        .card:hover{
            transform: translate3d(0,-4px,0);
            box-shadow: var(--shadow2);
            border-color: rgba(255,255,255,.22);
        }

        .card-header{
            display:flex;
            justify-content: space-between;
            align-items:center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .card-title{
            font-size: 14px;
            font-weight: 700;
            letter-spacing: .4px;
            color: rgba(255,255,255,.88);
        }

        .card-icon{
            width: 40px;
            height: 40px;
            border-radius: 14px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size: 18px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(255,255,255,.06);
            box-shadow: 0 10px 25px rgba(0,0,0,.22);
            transform: translate3d(0,0,0);
        }

        .icon-status{ background: linear-gradient(135deg, rgba(102,126,234,.45), rgba(118,75,162,.35)); }
        .icon-motion{ background: linear-gradient(135deg, rgba(240,147,251,.35), rgba(245,87,108,.30)); }
        .icon-light{ background: linear-gradient(135deg, rgba(255,216,155,.28), rgba(25,84,123,.30)); }
        .icon-alarm{ background: linear-gradient(135deg, rgba(255,107,107,.34), rgba(238,90,111,.30)); }

        .metric-value{
            font-size: 44px;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(200,210,255,.85));
            -webkit-background-clip:text;
            -webkit-text-fill-color: transparent;
            margin: 6px 0 2px;
        }

        .metric-label{
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.4px;
        }

        .status-indicator{
            display:inline-flex;
            align-items:center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.06);
        }
        .status-indicator::before{
            content:"";
            width: 8px; height: 8px; border-radius: 50%;
            background: currentColor;
            opacity: .9;
        }

        .status-safe{ color: #34d399; border-color: rgba(52,211,153,.30); background: rgba(52,211,153,.10); }
        .status-motion{ color: #fbbf24; border-color: rgba(251,191,36,.30); background: rgba(251,191,36,.10); }
        .status-alert{ color: #fb7185; border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); animation: blink 1.1s var(--ease) infinite; }
        .status-standby{ color: #a5b4fc; border-color: rgba(165,180,252,.30); background: rgba(165,180,252,.10); }

        @keyframes blink{
            0%,100%{ filter: brightness(1); }
            50%{ filter: brightness(1.3); }
        }

        .progress-bar{
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.14);
            border-radius: 999px;
            overflow:hidden;
            margin-top: 10px;
        }
        .progress-fill{
            height:100%;
            background: linear-gradient(90deg, rgba(102,126,234,1), rgba(240,147,251,.95));
            border-radius: 999px;
            transition: width .45s var(--ease);
        }

        .info-grid{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        .info-item{
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.12);
            padding: 10px 12px;
            border-radius: 14px;
        }
        .info-item label{
            display:block;
            color: var(--muted);
            font-size: 11px;
            margin-bottom: 6px;
            letter-spacing: .3px;
        }
        .info-item value{
            font-weight: 750;
            color: rgba(255,255,255,.92);
            font-size: 14px;
        }

        .chart-container{
            grid-column: 1 / -1;
            height: 320px;
        }
        canvas{ image-rendering: auto; }

        .log-container{
            background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
            border: 1px solid var(--stroke);
            border-radius: var(--r);
            padding: 18px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            max-height: 420px;
            overflow:auto;
        }
        .log-container h3{ color: rgba(255,255,255,.9) !important; }

        .log-entry{
            padding: 10px 12px;
            margin: 8px 0;
            border-left: 3px solid rgba(102,126,234,.75);
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.10);
            border-radius: 14px;
            font-size: 13px;
            color: rgba(255,255,255,.88);
            transform: translate3d(0,0,0);
            animation: pop .35s var(--ease) both;
        }
        @keyframes pop{
            from{ opacity: 0; transform: translate3d(0,6px,0); }
            to{ opacity: 1; transform: translate3d(0,0,0); }
        }
        .log-entry .timestamp{
            color: rgba(255,255,255,.55);
            font-size: 11px;
            margin-right: 8px;
        }

        /* Mobile */
        @media (max-width: 768px){
            body{ padding: 14px; }
            header{ padding: 16px; }
            h1{ font-size: 18px; }
            .dashboard{ grid-template-columns: 1fr; }
            .chart-container{ height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo">&#128161;</div>
                Smart Safety Lamp Dashboard
            </h1>
            <div class="connection-status">
                <div class="status-badge disconnected" id="mqtt-status">
                    <div class="status-dot"></div>
                    <span>Connecting...</span>
                </div>
                <div class="status-badge disconnected" id="device-status">
                    <span>Device Offline</span>
                </div>
            </div>
        </header>

        <div class="dashboard">
            <!-- System Status Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">System Status</div>
                    <div class="card-icon icon-status">&#128737;</div>
                </div>
                <div class="status-indicator status-safe" id="system-status">SAFE</div>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Uptime</label>
                        <value id="uptime">00:00:00</value>
                    </div>
                    <div class="info-item">
                        <label>Device</label>
                        <value id="device-name">-</value>
                    </div>
                </div>
            </div>

            <!-- Motion Counter Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Motion Detected</div>
                    <div class="card-icon icon-motion">&#128075;</div>
                </div>
                <div class="metric-value" id="motion-count">0</div>
                <div class="metric-label">Total Detections</div>
                <div class="info-item" style="margin-top: 15px;">
                    <label>Current Status</label>
                    <value id="motion-status">No Motion</value>
                </div>
            </div>

            <!-- Light Sensor Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Light Sensor</div>
                    <div class="card-icon icon-light">&#9728;</div>
                </div>
                <div class="metric-value" id="light-value">0</div>
                <div class="metric-label">Brightness (0-4095 ADC)</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="light-progress" style="width: 0%"></div>
                </div>
                <div class="info-item" style="margin-top: 10px;">
                    <label>Condition</label>
                    <value id="light-condition">Unknown</value>
                </div>
                <div class="info-item" style="margin-top: 15px;">
                    <label>Changes Today</label>
                    <value id="light-changes">0</value>
                </div>
            </div>

            <!-- Alarm Counter Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Alarm Events</div>
                    <div class="card-icon icon-alarm">&#128680;</div>
                </div>
                <div class="metric-value" id="alarm-count">0</div>
                <div class="metric-label">Motion in Dark Events</div>
                <div class="info-item" style="margin-top: 15px;">
                    <label>Alarm Status</label>
                    <value id="alarm-status">Inactive</value>
                </div>
            </div>

            <!-- Lamp Hold Time Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Set Time Lamp</div>
                    <div class="card-icon icon-status">&#9201;</div>
                </div>
                <div class="info-item">
                    <label>Set Time Lamp (detik)</label>
                    <input id="hold-seconds-input" type="number" min="1" max="600" value="10" style="width:100%; margin-top:6px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff;">
                </div>
                <button id="set-hold-btn" style="margin-top:12px; width:100%; padding:9px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.25); background:rgba(102,126,234,.5); color:#fff; cursor:pointer;">Apply</button>
                <div class="info-item" style="margin-top: 12px;">
                    <label>Current Time Lamp</label>
                    <value id="hold-seconds-current">10 s</value>
                </div>
            </div>

            <!-- Chart Card -->
            <div class="card chart-container">
                <div class="card-header">
                    <div class="card-title">Activity History</div>
                </div>
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="log-container">
            <h3 style="margin-bottom: 15px; color: #333;">Activity Log</h3>
            <div id="activity-log"></div>
        </div>
    </div>

    <script>
        // MQTT Configuration
        const MQTT_BROKER = 'wss://d292dd46dc934614a75640a26a74440a.s1.eu.hivemq.cloud:8884/mqtt';
        const MQTT_OPTIONS = {
            username: 'smartk2',
            password: 'Smartk22.',
            reconnectPeriod: 2000,
            connectTimeout: 10000,
            clean: true,
            clientId: 'smartlamp_web_' + Math.random().toString(16).slice(2, 8)
        };
        const TOPICS = {
            status: 'smartlamp/status',
            motion: 'smartlamp/motion',
            light: 'smartlamp/light',
            alarm: 'smartlamp/alarm',
            counter: 'smartlamp/counter',
            command: 'smartlamp/command'
        };

        // Variables
        let mqttClient;
        let motionData = [];
        let alarmData = [];
        let timeLabels = [];
        let activityChart;
        const CHART_INTERVAL_MS = 2 * 60 * 1000;
        let chartIntervalId = null;
        let intervalMotionCount = 0;
        let lastMotionTotal = null;
        let latestAlarmValue = 0;

        
        // Initialize Chart (lighter + smoother + fixed point alignment)
        function initChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');

            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Motion Events',
                            data: motionData,
                            borderColor: 'rgba(240, 147, 251, 1)',
                            backgroundColor: 'rgba(240, 147, 251, 0.12)',
                            tension: 0.35,
                            pointRadius: 0,
                            pointHitRadius: 10,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'Alarm Events',
                            data: alarmData,
                            borderColor: 'rgba(255, 107, 107, 1)',
                            backgroundColor: 'rgba(255, 107, 107, 0.10)',
                            tension: 0.35,
                            pointRadius: 0,
                            pointHitRadius: 10,
                            fill: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 600,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'rgba(255,255,255,.82)',
                                boxWidth: 10,
                                boxHeight: 10,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255,255,255,.65)',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            },
                            grid: {
                                color: 'rgba(255,255,255,.06)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255,255,255,.65)',
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(255,255,255,.06)'
                            }
                        }
                    }
                }
            });
        }

        // Push one aligned data point (prevents double labels / jagged lines)
        function pushChartPoint(motionVal, alarmVal) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            timeLabels.push(timeStr);
            motionData.push(motionVal);
            alarmData.push(alarmVal);

            // Keep only last 30 points
            const MAX_POINTS = 30;
            if (timeLabels.length > MAX_POINTS) {
                timeLabels.shift();
                motionData.shift();
                alarmData.shift();
            }

            if (activityChart) activityChart.update('none');
        }

        function flushChartInterval() {
            pushChartPoint(intervalMotionCount, latestAlarmValue);
            intervalMotionCount = 0;
        }

        function startChartInterval() {
            if (chartIntervalId) {
                clearInterval(chartIntervalId);
            }
            chartIntervalId = setInterval(flushChartInterval, CHART_INTERVAL_MS);
        }

        // Connect to MQTT
        function connectMQTT() {
            addLog('Connecting to MQTT broker...');
            mqttClient = mqtt.connect(MQTT_BROKER, MQTT_OPTIONS);

            mqttClient.on('connect', () => {
                console.log('Connected to MQTT broker');
                updateMQTTStatus(true);
                addLog('Connected to MQTT broker');

                // Subscribe to all topics
                Object.values(TOPICS).forEach(topic => {
                    mqttClient.subscribe(topic);
                    console.log('Subscribed to:', topic);
                });
            });

            mqttClient.on('message', (topic, message) => {
                handleMessage(topic, message.toString());
            });

            mqttClient.on('error', (error) => {
                console.error('MQTT Error:', error);
                updateMQTTStatus(false);
                addLog('MQTT connection error');
            });

            mqttClient.on('close', () => {
                updateMQTTStatus(false);
                addLog('MQTT connection closed');
            });
        }

        // Handle MQTT Messages
        function handleMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                
                switch(topic) {
                    case TOPICS.status:
                        updateSystemStatus(data);
                        break;
                    case TOPICS.motion:
                        updateMotion(data);
                        break;
                    case TOPICS.light:
                        updateLight(data);
                        break;
                    case TOPICS.alarm:
                        updateAlarm(data);
                        break;
                    case TOPICS.counter:
                        updateCounters(data);
                        break;
                }
            } catch (error) {
                console.error('Error parsing message:', error);
            }
        }

        // Update System Status
        function updateSystemStatus(data) {
            const statusElement = document.getElementById('system-status');
            const deviceStatus = document.getElementById('device-status');
            
            // Update device status
            deviceStatus.className = 'status-badge connected';
            deviceStatus.innerHTML = '<span>Device Online</span>';
            
            // Update system status
            statusElement.className = 'status-indicator status-' + data.status;
            statusElement.textContent = data.status.toUpperCase();
            
            // Update device name
            if (data.device) {
                document.getElementById('device-name').textContent = data.device;
            }
            
            // Update uptime
            if (data.uptime) {
                const hours = Math.floor(data.uptime / 3600);
                const minutes = Math.floor((data.uptime % 3600) / 60);
                const seconds = data.uptime % 60;
                document.getElementById('uptime').textContent = 
                    `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            }
            
            // Update light value
            if (data.light !== undefined) {
                updateLightValue(data.light);
            }
            if (data.is_dark !== undefined) {
                document.getElementById('light-condition').textContent =
                    data.is_dark ? 'Dark' : 'Bright';
            }
            
            // Update motion status
            if (data.motion !== undefined) {
                document.getElementById('motion-status').textContent = 
                    data.motion ? 'Motion Detected' : 'No Motion';
            }
            
            // Update alarm status
            if (data.alarm !== undefined) {
                document.getElementById('alarm-status').textContent = 
                    data.alarm ? 'ACTIVE ALERT' : 'Inactive';
            }
            if (data.hold_ms !== undefined) {
                const sec = Math.max(1, Math.round(data.hold_ms / 1000));
                document.getElementById('hold-seconds-current').textContent = `${sec} s`;
            }
        }

        // Update Motion
        function updateMotion(data) {
            if (data.detected) {
                addLog('Motion detected!');
            }
            if (data.count !== undefined) {
                document.getElementById('motion-count').textContent = data.count;
            }
        }

        // Update Light
        function updateLight(data) {
            const rawValue = (data && data.light !== undefined) ? data.light : data;
            const value = parseInt(rawValue, 10);
            if (!Number.isNaN(value)) {
                updateLightValue(value);
            }
            if (data && data.dark !== undefined) {
                document.getElementById('light-condition').textContent =
                    data.dark ? 'Dark' : 'Bright';
            }
            addLog(`Light level changed: ${rawValue}`);
        }

        function updateLightValue(value) {
            document.getElementById('light-value').textContent = value;
            const percentage = ((4095 - value) / 4095) * 100; // Higher ADC value means darker for this wiring
            document.getElementById('light-progress').style.width = percentage + '%';
        }

        // Update Alarm
        function updateAlarm(data) {
            if (data.active) {
                addLog('ALARM TRIGGERED!');
            }
            if (data.active !== undefined) {
                document.getElementById('alarm-status').textContent =
                    data.active ? 'ACTIVE ALERT' : 'Inactive';
            }
            if (data.count !== undefined) {
                document.getElementById('alarm-count').textContent = data.count;
            }
        }

        
        // Update Counters
        function updateCounters(data) {
            const hasMotion = (data.motion !== undefined);
            const hasAlarm = (data.alarm !== undefined);

            // Update visible counters
            if (hasMotion) {
                document.getElementById('motion-count').textContent = data.motion;
                const currentMotionTotal = Number(data.motion);
                if (Number.isFinite(currentMotionTotal)) {
                    if (lastMotionTotal === null) {
                        lastMotionTotal = currentMotionTotal;
                    } else if (currentMotionTotal >= lastMotionTotal) {
                        intervalMotionCount += (currentMotionTotal - lastMotionTotal);
                        lastMotionTotal = currentMotionTotal;
                    } else {
                        // Counter reset from device; restart baseline.
                        lastMotionTotal = currentMotionTotal;
                    }
                }
            }
            if (hasAlarm) {
                document.getElementById('alarm-count').textContent = data.alarm;
                const currentAlarmValue = Number(data.alarm);
                if (Number.isFinite(currentAlarmValue)) {
                    latestAlarmValue = currentAlarmValue;
                }
            }
            if (data.light_change !== undefined) {
                document.getElementById('light-changes').textContent = data.light_change;
            }
        }

        
        // Update Chart
        // (moved to pushChartPoint() to keep labels & datasets aligned)
        function updateChart(type, value) {
            // Backward-compatible wrapper
            const lastMotion = motionData[motionData.length - 1] ?? 0;
            const lastAlarm = alarmData[alarmData.length - 1] ?? 0;
            if (type === 'motion') {
                pushChartPoint(value, lastAlarm);
            } else {
                pushChartPoint(lastMotion, value);
            }
        }

        // Update MQTT Status
        function updateMQTTStatus(connected) {
            const statusElement = document.getElementById('mqtt-status');
            if (connected) {
                statusElement.className = 'status-badge connected';
                statusElement.innerHTML = '<div class="status-dot"></div><span>Connected</span>';
            } else {
                statusElement.className = 'status-badge disconnected';
                statusElement.innerHTML = '<div class="status-dot"></div><span>Disconnected</span>';
            }
        }

        // Add Activity Log
        function addLog(message) {
            const logContainer = document.getElementById('activity-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Utility: Pad numbers
        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        function applyHoldTime() {
            const input = document.getElementById('hold-seconds-input');
            const sec = parseInt(input.value, 10);
            if (Number.isNaN(sec) || sec < 1 || sec > 600) {
                addLog('Set Time Lamp harus 1-600 detik');
                return;
            }
            if (!mqttClient || !mqttClient.connected) {
                addLog('MQTT belum terkoneksi');
                return;
            }
            const payload = JSON.stringify({ hold_ms: sec * 1000 });
            mqttClient.publish(TOPICS.command, payload);
            document.getElementById('hold-seconds-current').textContent = `${sec} s`;
            addLog(`Set Time Lamp: ${sec} detik`);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initChart();
            startChartInterval();
            connectMQTT();
            document.getElementById('set-hold-btn').addEventListener('click', applyHoldTime);
            addLog('Dashboard initialized');
        });
    </script>
</body>
</html>

